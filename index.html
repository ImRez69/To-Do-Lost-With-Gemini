<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>مدیریت وظایف درختی پیشرفته</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #f3f4f6; --text-color: #1f2937; --card-bg-color: #ffffff; --card-item-bg-color: #f9fafb; --border-color: #e5e7eb; --input-border-color: #d1d5db; --header-text-color: #374151; --subheader-text-color: #6b7280; --ring-color: rgba(59, 130, 246, 0.5);
        }
        .dark {
            --bg-color: #111827; --text-color: #f9fafb; --card-bg-color: #1f2937; --card-item-bg-color: #374151; --border-color: #4b5563; --input-border-color: #4b5563; --header-text-color: #d1d5db; --subheader-text-color: #9ca3af; --ring-color: rgba(96, 165, 250, 0.5);
        }
        body { font-family: 'Vazirmatn', sans-serif; background-color: var(--bg-color); color: var(--text-color); transition: background-color 0.3s, color 0.3s; }
        .card { background-color: var(--card-bg-color); transition: background-color 0.3s; }
        .task-item { background-color: var(--card-item-bg-color); border-color: var(--border-color); transition: background-color 0.3s, border-color 0.3s; }
        .main-header { color: var(--header-text-color); }
        .sub-header { color: var(--subheader-text-color); }
        .border-color { border-color: var(--border-color); }
        .custom-input { background-color: var(--card-bg-color); border-color: var(--input-border-color); }
        .custom-input:focus { --tw-ring-color: var(--ring-color); }
        @keyframes fade-in { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .task-item-animation { animation: fade-in 0.3s ease-out forwards; }
        .file-input-button { cursor: pointer; display: inline-block; }
        .file-input-hidden { display: none; }
        .dragging { opacity: 0.5; }
        .drag-over { border: 2px dashed var(--ring-color); }
    </style>
</head>
<body>

    <div class="container mx-auto p-4 md:p-8 max-w-4xl">
        <div class="flex justify-between items-center mb-8">
            <header class="text-center flex-grow">
                <h1 class="text-4xl font-bold main-header">برنامه‌ریز درختی پیشرفته</h1>
                <p class="sub-header mt-2">وظایف خود را مدیریت، ویرایش و سازماندهی کنید.</p>
            </header>
            <button id="theme-toggle" class="p-2 rounded-full hover:bg-gray-500/20 transition">
                <svg id="theme-toggle-dark-icon" class="w-6 h-6 hidden" fill="currentColor" viewBox="0 0 20 20"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path></svg>
                <svg id="theme-toggle-light-icon" class="w-6 h-6 hidden" fill="currentColor" viewBox="0 0 20 20"><path d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 14.95a1 1 0 010-1.414l.707-.707a1 1 0 011.414 1.414l-.707.707a1 1 0 01-1.414 0zM3 11a1 1 0 100-2H2a1 1 0 100 2h1z" fill-rule="evenodd" clip-rule="evenodd"></path></svg>
            </button>
        </div>

        <div class="card rounded-lg shadow-md p-6 mb-8">
            <h2 class="text-2xl font-semibold mb-4">وظیفه جدیدی اضافه کن</h2>
            <div class="flex flex-col sm:flex-row gap-4">
                <input type="text" id="newTaskInput" placeholder="مثال: برنامه‌ریزی سفر به شمال..." class="custom-input flex-grow p-3 border rounded-lg focus:outline-none focus:ring-2 transition">
                <button id="addTaskBtn" class="bg-blue-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-blue-700 transition shadow-sm">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block ml-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                    اضافه کردن
                </button>
            </div>
        </div>

        <div id="taskListContainer" class="card rounded-lg shadow-md p-6">
            <h3 class="text-xl font-semibold mb-4 border-b pb-2 border-color">لیست برنامه‌ها</h3>
            <ul id="taskList" class="space-y-4"></ul>
        </div>
    </div>

    <!-- Modal for previewing attachments -->
    <div id="preview-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50 hidden">
        <div id="modal-content" class="card p-4 rounded-lg max-w-3xl max-h-[90vh] relative">
            <button id="close-modal" class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-8 h-8 flex items-center justify-center text-lg z-10">&times;</button>
            <div id="modal-body" class="overflow-auto max-h-[85vh]"></div>
        </div>
    </div>
    
    <!-- Modal for confirmation -->
    <div id="confirm-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="card rounded-lg shadow-xl p-6 w-full max-w-sm">
            <p id="confirm-message" class="text-lg mb-4">آیا از حذف این مورد مطمئن هستید؟</p>
            <div class="flex justify-end gap-4">
                <button id="confirm-cancel" class="px-4 py-2 rounded-lg hover:bg-gray-500/20 transition">لغو</button>
                <button id="confirm-ok" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition">بله، حذف کن</button>
            </div>
        </div>
    </div>


    <script>
        // --- مدیریت حالت تاریک ---
        const themeToggleBtn = document.getElementById('theme-toggle');
        const darkIcon = document.getElementById('theme-toggle-dark-icon');
        const lightIcon = document.getElementById('theme-toggle-light-icon');

        if (localStorage.getItem('color-theme') === 'dark' || (!('color-theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
            lightIcon.classList.remove('hidden');
        } else {
            document.documentElement.classList.remove('dark');
            darkIcon.classList.remove('hidden');
        }

        themeToggleBtn.addEventListener('click', function() {
            darkIcon.classList.toggle('hidden');
            lightIcon.classList.toggle('hidden');
            document.documentElement.classList.toggle('dark');
            if (document.documentElement.classList.contains('dark')) {
                localStorage.setItem('color-theme', 'dark');
            } else {
                localStorage.setItem('color-theme', 'light');
            }
        });

        // --- توابع ذخیره‌سازی و بارگذاری ---
        function saveTasks() {
            localStorage.setItem('tasksData', JSON.stringify(tasks));
        }

        function loadTasks() {
            const savedTasks = localStorage.getItem('tasksData');
            try {
                if (savedTasks) return JSON.parse(savedTasks);
            } catch (e) { console.error("Error parsing tasks from localStorage", e); }
            return [];
        }

        // --- منطق اصلی برنامه ---
        let tasks = loadTasks();
        const taskList = document.getElementById('taskList');
        const newTaskInput = document.getElementById('newTaskInput');
        const addTaskBtn = document.getElementById('addTaskBtn');

        function renderTasks() {
            taskList.innerHTML = '';
            tasks.forEach(task => {
                const taskElement = createTaskElement(task);
                taskList.appendChild(taskElement);
            });
        }

        function createTaskElement(task) {
            const li = document.createElement('li');
            li.setAttribute('data-id', task.id);
            li.className = 'task-item task-item-animation p-4 rounded-lg border';

            // View Mode Content
            const viewContent = document.createElement('div');
            viewContent.className = 'view-mode';

            const mainContent = document.createElement('div');
            mainContent.className = 'flex items-center justify-between flex-wrap gap-y-2';
            const taskText = document.createElement('span');
            taskText.textContent = task.text;
            taskText.className = 'font-medium text-lg';
            mainContent.appendChild(taskText);
            
            const buttonsContainer = document.createElement('div');
            buttonsContainer.className = 'flex items-center gap-2 flex-shrink-0';
            const editBtn = createButton('ویرایش', 'bg-indigo-500', () => toggleEditMode(task.id, true));
            buttonsContainer.appendChild(editBtn);
            const addSubtaskBtn = createButton('زیرمجموعه', 'bg-green-500', () => showSubtaskInput(task.id));
            buttonsContainer.appendChild(addSubtaskBtn);
            const attachFileBtn = createFileInput(task.id);
            buttonsContainer.appendChild(attachFileBtn);
            const deleteBtn = createButton('حذف', 'bg-red-500', () => confirmDeleteTask(task.id));
            buttonsContainer.appendChild(deleteBtn);
            mainContent.appendChild(buttonsContainer);
            viewContent.appendChild(mainContent);
            
            const attachmentsContainer = document.createElement('div');
            attachmentsContainer.className = 'mt-3 flex flex-wrap gap-2 attachments-view';
            renderAttachments(attachmentsContainer, task, false);
            viewContent.appendChild(attachmentsContainer);
            
            li.appendChild(viewContent);

            // Edit Mode Content (initially hidden)
            const editContent = document.createElement('div');
            editContent.className = 'edit-mode hidden';
            
            const editForm = document.createElement('div');
            editForm.className = 'flex flex-col gap-4';
            const titleInput = document.createElement('input');
            titleInput.type = 'text';
            titleInput.value = task.text;
            titleInput.className = 'custom-input text-lg p-2 border rounded-lg';
            editForm.appendChild(titleInput);

            const attachmentsEditContainer = document.createElement('div');
            attachmentsEditContainer.className = 'mt-1 flex flex-wrap gap-2 attachments-edit';
            attachmentsEditContainer.innerHTML = `<p class="text-sm sub-header w-full mb-1">ضمیمه‌ها (برای جابجایی بکشید و رها کنید)</p>`;
            renderAttachments(attachmentsEditContainer, task, true);
            editForm.appendChild(attachmentsEditContainer);

            const editButtons = document.createElement('div');
            editButtons.className = 'flex justify-end gap-2 mt-2';
            const saveBtn = createButton('ذخیره', 'bg-blue-600', () => saveChanges(task.id));
            const cancelBtn = createButton('لغو', 'bg-gray-500', () => toggleEditMode(task.id, false));
            editButtons.appendChild(cancelBtn);
            editButtons.appendChild(saveBtn);
            editForm.appendChild(editButtons);

            editContent.appendChild(editForm);
            li.appendChild(editContent);


            // Subtasks
            const subtaskList = document.createElement('ul');
            subtaskList.className = 'mt-4 pr-6 space-y-3';
            if (task.children && task.children.length > 0) {
                task.children.forEach(childTask => {
                    const childElement = createTaskElement(childTask);
                    subtaskList.appendChild(childElement);
                });
            }
            li.appendChild(subtaskList);
            return li;
        }

        function renderAttachments(container, task, isEditMode) {
            container.querySelectorAll('.attachment-item').forEach(el => el.remove()); // Clear previous
            task.attachments.forEach((file, index) => {
                const fileContainer = document.createElement('div');
                fileContainer.className = 'relative attachment-item';
                if (isEditMode) {
                    fileContainer.draggable = true;
                    fileContainer.dataset.index = index;
                }

                const renderEl = createAttachmentPreview(file);
                renderEl.onclick = isEditMode ? null : () => openModal(file.url, file.type);
                fileContainer.appendChild(renderEl);

                if (isEditMode) {
                    const deleteAttachmentBtn = document.createElement('button');
                    deleteAttachmentBtn.innerHTML = '&times;';
                    deleteAttachmentBtn.className = 'absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-sm';
                    deleteAttachmentBtn.onclick = () => {
                        task.attachments.splice(index, 1);
                        saveTasks();
                        renderTasks(); // Re-render to update the view
                    };
                    fileContainer.appendChild(deleteAttachmentBtn);
                }
                container.appendChild(fileContainer);
            });
             // Add drag-and-drop listeners if in edit mode
            if (isEditMode) {
                addDragDropListeners(container, task);
            }
        }

        function createAttachmentPreview(file) {
            if (file.type.startsWith('image/')) {
                const img = document.createElement('img');
                img.src = file.url;
                img.alt = file.name;
                img.className = 'w-20 h-20 object-cover rounded-md border-2 border-color hover:opacity-80 transition cursor-pointer';
                return img;
            } else if (file.type.startsWith('video/')) {
                const videoContainer = document.createElement('div');
                videoContainer.className = 'w-20 h-20 bg-black rounded-md flex items-center justify-center border-2 border-color hover:opacity-80 transition cursor-pointer';
                videoContainer.innerHTML = `<svg class="w-8 h-8 text-white" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd"></path></svg>`;
                return videoContainer;
            } else {
                const fileElement = document.createElement('div');
                fileElement.className = 'text-sm sub-header bg-gray-200 dark:bg-gray-600 px-2 py-1 rounded-md inline-flex items-center justify-center text-center h-20 w-20 break-all';
                fileElement.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mb-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z" /></svg><span class="truncate">${file.name}</span>`;
                return fileElement;
            }
        }
        
        function createButton(text, bgColor, onClick) {
            const button = document.createElement('button');
            button.innerHTML = text;
            button.className = `${bgColor} text-white px-3 py-1 rounded-md text-sm font-semibold hover:opacity-80 transition`;
            button.onclick = onClick;
            return button;
        }

        function createFileInput(taskId) {
            const container = document.createElement('div');
            container.className = 'relative';
            const label = document.createElement('label');
            label.className = 'file-input-button bg-yellow-500 text-white px-3 py-1 rounded-md text-sm font-semibold hover:opacity-80 transition';
            label.textContent = 'ضمیمه';
            const input = document.createElement('input');
            input.type = 'file';
            input.className = 'file-input-hidden';
            input.onchange = (e) => attachFile(taskId, e.target.files[0]);
            label.appendChild(input);
            container.appendChild(label);
            return container;
        }

        function showSubtaskInput(parentId) {
            const parentLi = document.querySelector(`li[data-id='${parentId}']`);
            if (parentLi.querySelector('.subtask-input-container')) return;
            const container = document.createElement('div');
            container.className = 'subtask-input-container flex gap-2 mt-3 p-2 rounded-lg';
            container.style.backgroundColor = 'var(--bg-color)';
            const input = document.createElement('input');
            input.type = 'text';
            input.placeholder = 'عنوان زیرمجموعه...';
            input.className = 'custom-input flex-grow p-2 border rounded-lg focus:outline-none focus:ring-2';
            const addBtn = createButton('افزودن', 'bg-green-600', () => {
                if (input.value.trim()) {
                    addTask(input.value.trim(), parentId);
                    container.remove();
                }
            });
            const cancelBtn = createButton('لغو', 'bg-gray-400', () => container.remove());
            container.appendChild(input);
            container.appendChild(addBtn);
            container.appendChild(cancelBtn);
            parentLi.insertBefore(container, parentLi.querySelector('ul'));
            input.focus();
        }

        function findTask(taskId, taskArray = tasks) {
            for (const task of taskArray) {
                if (task.id === taskId) return task;
                if (task.children.length > 0) {
                    const found = findTask(taskId, task.children);
                    if (found) return found;
                }
            }
            return null;
        }

        function addTask(text, parentId = null) {
            const newTask = { id: Date.now().toString() + Math.random(), text: text, children: [], attachments: [] };
            if (parentId === null) {
                tasks.push(newTask);
            } else {
                const parentTask = findTask(parentId);
                if (parentTask) parentTask.children.push(newTask);
            }
            saveTasks();
            renderTasks();
        }

        function confirmDeleteTask(taskId) {
            showConfirmModal('آیا از حذف این وظیفه و تمام زیرمجموعه‌های آن مطمئن هستید؟', () => {
                deleteTask(taskId);
            });
        }

        function deleteTask(taskId, taskArray = tasks) {
             for (let i = 0; i < taskArray.length; i++) {
                if (taskArray[i].id === taskId) {
                    taskArray.splice(i, 1);
                    saveTasks();
                    renderTasks();
                    return true;
                }
                if (taskArray[i].children.length > 0) {
                    if (deleteTask(taskId, taskArray[i].children)) return true;
                }
            }
            return false;
        }
        
        function attachFile(taskId, file) {
            if (!file) return;
            const task = findTask(taskId);
            if (task) {
                if (file.size > 5 * 1024 * 1024) { // 5MB limit
                    alert('فایل حجیم است! به دلیل محدودیت‌های مرورگر، ممکن است ذخیره نشود.');
                }
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => {
                    task.attachments.push({ name: file.name, type: file.type, url: reader.result });
                    saveTasks();
                    renderTasks();
                };
            }
        }
        
        // --- توابع ویرایش ---
        function toggleEditMode(taskId, isEditing) {
            const taskLi = document.querySelector(`li[data-id='${taskId}']`);
            const viewMode = taskLi.querySelector('.view-mode');
            const editMode = taskLi.querySelector('.edit-mode');
            viewMode.classList.toggle('hidden', isEditing);
            editMode.classList.toggle('hidden', !isEditing);
        }

        function saveChanges(taskId) {
            const task = findTask(taskId);
            const taskLi = document.querySelector(`li[data-id='${taskId}']`);
            const titleInput = taskLi.querySelector('.edit-mode input[type="text"]');
            
            if (task && titleInput) {
                task.text = titleInput.value.trim();
                // Attachment order is already saved by drag-drop, so just save all tasks
                saveTasks();
            }
            renderTasks(); // Re-render to show updated view
        }

        // --- توابع Drag & Drop ---
        let draggedItem = null;
        function addDragDropListeners(container, task) {
            container.addEventListener('dragstart', e => {
                draggedItem = e.target.closest('.attachment-item');
                setTimeout(() => {
                    draggedItem.classList.add('dragging');
                }, 0);
            });

            container.addEventListener('dragend', e => {
                setTimeout(() => {
                    draggedItem.classList.remove('dragging');
                    draggedItem = null;
                }, 0);
            });

            container.addEventListener('dragover', e => {
                e.preventDefault();
                const afterElement = getDragAfterElement(container, e.clientY);
                const currentDragged = document.querySelector('.dragging');
                if (afterElement == null) {
                    container.appendChild(currentDragged);
                } else {
                    container.insertBefore(currentDragged, afterElement);
                }
            });
            
            container.addEventListener('drop', e => {
                e.preventDefault();
                const newOrder = Array.from(container.querySelectorAll('.attachment-item')).map(item => {
                    return task.attachments[parseInt(item.dataset.index)];
                });
                task.attachments = newOrder;
                saveTasks();
                renderTasks();
            });
        }

        function getDragAfterElement(container, y) {
            const draggableElements = [...container.querySelectorAll('.attachment-item:not(.dragging)')];
            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;
                if (offset < 0 && offset > closest.offset) {
                    return { offset: offset, element: child };
                } else {
                    return closest;
                }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }


        // --- منطق مودال‌ها ---
        const previewModal = document.getElementById('preview-modal');
        const previewModalBody = document.getElementById('modal-body');
        const closeModalBtn = document.getElementById('close-modal');
        const confirmModal = document.getElementById('confirm-modal');
        const confirmOkBtn = document.getElementById('confirm-ok');
        const confirmCancelBtn = document.getElementById('confirm-cancel');
        const confirmMessage = document.getElementById('confirm-message');

        function openModal(src, type) {
            previewModalBody.innerHTML = '';
            if (type.startsWith('image/')) {
                previewModalBody.innerHTML = `<img src="${src}" class="max-w-full max-h-[80vh] rounded">`;
            } else if (type.startsWith('video/')) {
                previewModalBody.innerHTML = `<video src="${src}" controls autoplay class="max-w-full max-h-[80vh] rounded"></video>`;
            }
            previewModal.classList.remove('hidden');
        }

        function closeModal() {
            previewModalBody.innerHTML = '';
            previewModal.classList.add('hidden');
        }

        function showConfirmModal(message, callback) {
            confirmMessage.textContent = message;
            confirmModal.classList.remove('hidden');
            confirmOkBtn.onclick = () => {
                callback();
                hideConfirmModal();
            };
        }

        function hideConfirmModal() {
            confirmModal.classList.add('hidden');
        }

        closeModalBtn.addEventListener('click', closeModal);
        previewModal.addEventListener('click', (e) => { if (e.target === previewModal) closeModal(); });
        confirmCancelBtn.addEventListener('click', hideConfirmModal);
        
        
        // --- Event Listeners اصلی ---
        addTaskBtn.addEventListener('click', () => {
            const text = newTaskInput.value.trim();
            if (text) {
                addTask(text);
                newTaskInput.value = '';
            }
        });

        newTaskInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') addTaskBtn.click();
        });
        
        // رندر اولیه
        renderTasks();
    </script>

</body>
</html>
